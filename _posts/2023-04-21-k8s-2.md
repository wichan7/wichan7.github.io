---
title: "쿠버네티스 - 2 [업데이트중]"
categories: 
  - infrastructure
tags:
  - kubernetes
  - k8s
---

# 프로비저닝
## 프로비저닝이란..
사용자의 요구에 맞게 시스템 자원을 할당, 배치, 배포해 두었다가 필요 시 시스템을 즉시 사용할 수 있는 상태로 미리 준비해 두는 것을 말한다.

## 프로비저닝 방법 선택
k8s를 프로비저닝하기 위한 유명한 방법으로 3가지가 있다. 
1. kubernetes  
여러 클러스터 구성 요소들을 직접 설치하고 설정한다.  
1. kubeadm  
k8s를 쉽게 구현할 수 있도록 도와주는 부트스트랩 툴이다.   
k8s에서 공식적으로 지원하고, 업데이트하는 k8s 구현 툴이다.
1. kops  
kubeadm과 마찬가지로 쉽게 구현하기 위한 부트스트랩 툴이나, '클라우드 플랫폼' 에서 쉽게 k8s를 설치할 수 있도록 도와주는 도구이다.

학습자의 입장으로... (1)을 배우면 좋겠다만, 너무 어려워 클러스터 구성도 전에 포기할 것만 같았다.  
(1)에 대한 튜토리얼은 다음 문서를 참고하길.. '[kubernetes-the-hard-way-tutorial](https://github.com/kelseyhightower/kubernetes-the-hard-way)'  
  

타협을 봐서.. 너무 많은 부분을 서포트하는 kops를 제하고, kubeadm으로 먼저 스터디하고, 기능에 익숙해지면 1을 공부해보자.  

# 구성요소 설치하기
참조1: [ec2에 kubeadm 설치](https://velog.io/@eunbyul/AWS-EC2%EC%97%90-kubernetes-%EC%84%A4%EC%B9%98%ED%95%98%EA%B8%B0)  

## 0. 들어가기에 앞서.. 
Amazon linux2 AMI의 yum repo $basearch가 일반 배포판 리눅스와 달라서인지, 다운로드에서 삽질을 했다.  
꼭 배포판 리눅스(Red hat... 등)를 AMI로 사용하자. docker, kube...를 Amazon Linux2에서 잘 설치할 수 있다면 상관은 없다.  

## 1. 필수 설치파일 다운로드를 위한 yum repository 설정하기 
1. docker, containerd 설치를 위해 repo를 설정한다.
```
cd /etc/yum.repos.d  
sudo wget https://download.docker.com/linux/centos/docker-ce.repo  
```

2. kubectl, kubeadm, kubelet 설치를 위해 repo를 설정한다. 
```
cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
[kubernetes]
name=Kubernetes
baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64
enabled=1
gpgcheck=1
repo_gpgcheck=1
gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg
exclude=kube*
EOF
```

## 2. 필수 설치파일 설치
docker-ce, containerd, kubeadm, kubectl, kubelet
```
sudo yum install containerd.io  
sudo yum install kubelet kubeadm kubectl --disableexcludes=kubernetes
```

## 3. 리눅스 설정 변경
1. Selinux 설정을 permissive 모드로 변경  
```
sudo setenforce 0
sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config
sudo systemctl enable --now kubelet
```

2. Swap off  
   Linux 자체 Swap 기능을 사용하는 경우, 쿠버네티스의 자원 관리(포드 배치 등..)가 비정상적으로 동작할 수 있다.
```
sudo swapoff -a  
sudo sed -e '/swap/ s/^#*/#/' -i /etc/fstab
```

## 4. Containerd 설정 변경
1. containerd 설정
```
cat <<EOF | sudo tee /etc/modules-load.d/containerd.conf
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter
```

2. containerd를 위한 sysctl 파라미터 설정
```
# 필요한 sysctl 파라미터를 설정하면 재부팅 후에도 유지된다.
cat <<EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf
net.bridge.bridge-nf-call-iptables  = 1
net.ipv4.ip_forward                 = 1
net.bridge.bridge-nf-call-ip6tables = 1
EOF

# 재부팅하지 않고 sysctl 파라미터 적용
sudo sysctl --system
```

3. 재시작 시에도 containerd가 실행되도록 설정
```
sudo systemctl enable containerd
sudo systemctl restart containerd
```

## 5. kubeadm init
CNI로 Calico를 사용한다면, pod-network-cidr을 192.168.0.0/16으로 지정한다.  
Flannel은 10.244.0.0/16
```
sudo kubeadm init \
    --apiserver-advertise-address=172.31.44.57 \
    --pod-network-cidr=10.244.0.0/16 \
    --apiserver-cert-extra-sans=172.31.44.57
```

## 6. init 이후
```
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```

## 7. worker node join
```
sudo kubeadm join 172.31.44.57:6443 --token jle89r.6qqk9qlhx8wozd6p \
        --discovery-token-ca-cert-hash sha256:e37231d3d866429b0caa85b2a9dce668b69d68e016f9981123782d20475131ab
```

## 8. calico cni 설치
```
kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.25.0/manifests/calico.yaml
```

## 9. worker 노드에 scp로 config 파일 전달
worker에서도 kubectl 명령을 사용할 수 있도록, 컨피그 파일을 전달한다.
```
scp /home/ec2-user/.kube/config 172.31.32.49:/home/ec2-user/.kube
```

# 에러 처리
## kubeadm init 시 '[ERROR CRI]: container runtime is not running' 에러 발생
/etc/containerd/config.toml에 docker cri를 disable 하는 설정이 있었다.
```
sudo rm /etc/containerd/config.toml
sudo systemctl restart containerd
```

## kubeadm init 시 cpu, 메모리 관련 문제가 있는 경우
kubeadm 최소 사양으로 cpu2, ram2GB가 필요한데 t3.micro는 해당 최소사양에 만족하지 않는다.  
```
# 아래 옵션으로 사양 관련을 무시할 수 있다.
--ignore-preflight-erros=NumCPU,Mem
```

## Status from runtime service failed 에러 발생 시
```
sudo rm /etc/containerd/config.toml
sudo systemctl restart containerd
sudo kubeadm init ...
```

## kubeadm join 토큰, 써티 해시값 다시 얻기
```
kubeadm token list
openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'
```